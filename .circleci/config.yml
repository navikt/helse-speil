version: 2
jobs:
   build:
      working_directory: ~/speil
      docker:
         - image: circleci/node:12.2.0-stretch
      steps:
         - checkout
         - setup_remote_docker:
              docker_layer_caching: true
         - run:
              name: update-npm
              command: 'sudo npm install -g npm@latest'
         - restore_cache:
              key: dependency-cache-{{ checksum "package.json" }}
         - run:
              name: install-npm-deps
              command: npm install
         - save_cache:
              key: dependency-cache-{{ checksum "package.json" }}
              paths:
                 - ./node_modules
         - run:
              name: build client
              command: |
                 set -e
                 npm run build
         - run:
              name: build server
              command: |
                 set -e
                 npm run build-server
         - run:
              name: assemble and push docker image
              command: |
                 set -e
                 if [ -z "${CIRCLE_PULL_REQUEST}" ] && [ "${CIRCLE_BRANCH}" = "master" ]; then
                   export DOCKER_IMG_NAME="docker.pkg.github.com/navikt/helse-speil/speil"
                   export COMMIT_SHORT="$(git rev-parse --short HEAD)"
                   echo "export DOCKER_IMG_NAME=$DOCKER_IMG_NAME" >> $BASH_ENV
                   echo "export COMMIT_SHORT=$COMMIT_SHORT" >> $BASH_ENV

                   docker build . -t $DOCKER_IMG_NAME:$COMMIT_SHORT

                   echo $GITHUB_PASSWORD | docker login -u "$GITHUB_USERNAME" --password-stdin https://docker.pkg.github.com
                   docker push $DOCKER_IMG_NAME:$COMMIT_SHORT
                 else
                    echo "Not on master, skipping this step"
                 fi
         - run:
              name: deploy to preprod
              command: |
                 set -e
                 if [ -z "${CIRCLE_PULL_REQUEST}" ] && [ "${CIRCLE_BRANCH}" = "master" ]; then
                    docker create -v /nais --name naisyamlpreprod alpine:3.4 /bin/true
                    docker cp deploy/preprod.yaml naisyamlpreprod:/nais
                    PREPROD_NAISERATOR=$(docker run --volumes-from naisyamlpreprod mikefarah/yq yq r /nais/preprod.yaml -j)
                    PREPROD_NAISERATOR=$(echo $PREPROD_NAISERATOR | jq '.spec.image = "'$DOCKER_IMG_NAME':'$COMMIT_SHORT'"' -c)
                    PREPROD_DEPLOYMENT=$(cat deploy/deployreq.json | jq '.payload.kubernetes.resources += ['$PREPROD_NAISERATOR']')
                    PREPROD_DEPLOYMENT=$(echo $PREPROD_DEPLOYMENT | jq '.environment = "dev-fss"')
                    PREPROD_DEPLOYMENT=$(echo $PREPROD_DEPLOYMENT | jq '.ref = "'$COMMIT_SHORT'"')
                    curl -u "$GITHUB_USERNAME:$GITHUB_PASSWORD" --fail \
                        -X POST \
                        -d "$PREPROD_DEPLOYMENT" \
                        -H "Accept: application/vnd.github.ant-man-preview+json" \
                        https://api.github.com/repos/navikt/helse-speil/deployments
                 else
                    echo "Not on master, skipping this step"
                 fi
         - run:
              name: deploy to prod
              command: |
                 set -e
                 if [ -z "${CIRCLE_PULL_REQUEST}" ] && [ "${CIRCLE_BRANCH}" = "master" ]; then
                    docker create -v /nais --name naisyamlprod alpine:3.4 /bin/true
                    docker cp deploy/prod.yaml naisyamlprod:/nais
                    PROD_NAISERATOR=$(docker run --volumes-from naisyamlprod mikefarah/yq yq r /nais/prod.yaml -j)
                    PROD_NAISERATOR=$(echo $PROD_NAISERATOR | jq '.spec.image = "'$DOCKER_IMG_NAME':'$COMMIT_SHORT'"' -c)
                    PROD_DEPLOYMENT=$(cat deploy/deployreq.json | jq '.payload.kubernetes.resources += ['$PROD_NAISERATOR']')
                    PROD_DEPLOYMENT=$(echo $PROD_DEPLOYMENT | jq '.environment = "prod-fss"')
                    PROD_DEPLOYMENT=$(echo $PROD_DEPLOYMENT | jq '.ref = "'$COMMIT_SHORT'"')
                    curl -u "$GITHUB_USERNAME:$GITHUB_PASSWORD" --fail \
                        -X POST \
                        -d "$PROD_DEPLOYMENT" \
                        -H "Accept: application/vnd.github.ant-man-preview+json" \
                        https://api.github.com/repos/navikt/helse-speil/deployments
                 else
                    echo "Not on master, skipping this step"
                 fi
